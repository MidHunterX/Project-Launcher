#!/usr/bin/env bash

# -----------------------------[ CONFIGURATION ]----------------------------- #

# Default: project dir name
SESSION_NAME=""
# Default: none
# [ none | python | django | fastapi | nodejs | nextjs | elixir | rust | custom ]
PRIMARY_SETUP=""

# Settings: [ true | false ]
AUTOSTART_SERVER=true
AUTORUN_COMMANDS=true

# Services: [ true | false ]
USE_POSTGRES=false
USE_DOCKER=false
USE_MONGODB=false
USE_REDIS=false

# -----------------------------[ CUSTOM LAYOUT ]----------------------------- #

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd $SCRIPT_DIR

setup_custom_layout() {
  # NextJS Server
  cd $SCRIPT_DIR
  create_tmux_session "Server" "npm run dev"

  # FastAPI Server
  cd ../fast-api-project/
  source ./venv/bin/activate
  create_window "API" "fastapi dev main.py"
  deactivate

  cd $SCRIPT_DIR
  create_temp_window "Editor" "nvim"
}

# =========================================================================== #

# â–ˆâ–‘â–ˆ â–€â–ˆâ–€ â–ˆ â–ˆâ–‘â–‘ â–ˆâ–€
# â–ˆâ–„â–ˆ â–‘â–ˆâ–‘ â–ˆ â–ˆâ–„â–„ â–„â–ˆ

create_tmux_session() {
  local NAME="$1"
  local CMD="$2"
  tmux new-session -d -s "$SESSION_NAME" -n "$NAME"
  if command -v "${CMD%% *}" >/dev/null; then
    tmux send-keys -t "$SESSION_NAME" "$CMD"
    [ "$AUTOSTART_SERVER" = true ] && tmux send-keys -t "$SESSION_NAME" Enter
  fi
}

# create_window(str:window_name str:command int:window_index)
create_window() {
  local NAME="$1"
  local CMD="$2"
  if command -v "${CMD%% *}" >/dev/null; then
    tmux new-window -t "$SESSION_NAME" -n "$NAME"
    tmux send-keys -t "$SESSION_NAME" "$CMD"
    [ "$AUTORUN_COMMANDS" = true ] && tmux send-keys -t "$SESSION_NAME" Enter
  fi
}

# create_temp_window(str:window_name str:command)
create_temp_window() {
  local NAME="$1"
  local CMD="$2"
  if command -v "${CMD%% *}" >/dev/null; then
    tmux new-window -t "$SESSION_NAME" -n "$1" "$2"
  fi
}

# â–ˆâ–‘â–‘ â–„â–€â–ˆ â–ˆâ–„â–ˆ â–ˆâ–€â–ˆ â–ˆâ–‘â–ˆ â–€â–ˆâ–€ â–ˆâ–€
# â–ˆâ–„â–„ â–ˆâ–€â–ˆ â–‘â–ˆâ–‘ â–ˆâ–„â–ˆ â–ˆâ–„â–ˆ â–‘â–ˆâ–‘ â–„â–ˆ

setup_default_layout() {
  create_tmux_session "Cmd"
  create_temp_window "Editor" "nvim"
}

setup_python_layout() {
  create_tmux_session "Cmd" "python main.py"
  create_temp_window "Editor" "nvim"
}

setup_fastapi_layout() {
  create_tmux_session "Server" "fastapi dev main.py"
  create_temp_window "Editor" "nvim"
  create_window "Test" "clear && pytest"
}

setup_nextjs_layout() {
  create_tmux_session "Server" "npm run dev"
  create_temp_window "Editor" "nvim"
}

setup_django_layout() {
  create_tmux_session "Server" "python manage.py runserver"
  create_temp_window "Editor" "nvim"
  create_window "Test" "python manage.py test"
}

setup_node_layout() {
  create_tmux_session "Server" "npm start"
  create_temp_window "Editor" "nvim"
  create_window "Test" "npm test"
}

setup_rust_layout() {
  create_tmux_session "Run" "cargo run"
  create_temp_window "Editor" "nvim"
  create_window "Test" "cargo test"
}

setup_elixir_layout() {
  create_tmux_session "Server" "iex -S mix phx.server"
  create_temp_window "Editor" "nvim"
}

# â–ˆâ–€ â–ˆâ–€â–€ â–ˆâ–€â–ˆ â–ˆâ–‘â–ˆ â–ˆ â–ˆâ–€â–€ â–ˆâ–€â–€ â–ˆâ–€
# â–„â–ˆ â–ˆâ–ˆâ–„ â–ˆâ–€â–„ â–€â–„â–€ â–ˆ â–ˆâ–„â–„ â–ˆâ–ˆâ–„ â–„â–ˆ

init_services() {
  # Syntax: [systemctl-service-name]="$USE_SERVICE"
  declare -A SERVICES=(
    [postgresql]="$USE_POSTGRES"
    [docker]="$USE_DOCKER"
    [mongod]="$USE_MONGODB"
    [redis - server]="$USE_REDIS"
  )

  for service in "${!SERVICES[@]}"; do
    if [[ "${SERVICES[$service]}" = true ]]; then
      if ! systemctl is-active --quiet "$service"; then
        echo "ðŸš€ Starting up $service..."
        sudo systemctl start "$service"
      fi
    fi
  done
}

# â–ˆâ–€â–€ â–ˆâ–„â–‘â–ˆ â–ˆâ–‘â–ˆ   â–ˆâ–€ â–ˆâ–€â–€ â–€â–ˆâ–€ â–ˆâ–‘â–ˆ â–ˆâ–€â–ˆ
# â–ˆâ–ˆâ–„ â–ˆâ–‘â–€â–ˆ â–€â–„â–€   â–„â–ˆ â–ˆâ–ˆâ–„ â–‘â–ˆâ–‘ â–ˆâ–„â–ˆ â–ˆâ–€â–€

setup_env() {
  local DEPENDENCY_DIR="$1"
  local DEPENDENCY_CMD="$2"
  if [[ ! -d $DEPENDENCY_DIR ]]; then
    echo "ðŸš€ Setting up dependencies..."
    command -v ${DEPENDENCY_CMD%% *} >/dev/null || {
      echo "âŒ Error: ${DEPENDENCY_CMD%% *} not found"
      exit 1
    }
    $DEPENDENCY_CMD
  fi
}

setup_python_env() {
  local DEPENDENCY_DIR="venv/"
  local DEPENDENCY_CMD="python -m venv venv"
  if [[ ! -d $DEPENDENCY_DIR ]]; then
    setup_env "$DEPENDENCY_DIR" "$DEPENDENCY_CMD"
    echo "ðŸ“¦ Installing requirements..."
    source "$DEPENDENCY_DIR/bin/activate"
    if [[ -f "requirements.txt" ]]; then
      pip install -r requirements.txt
    else
      echo "ðŸš§ Warning: No requirements.txt found"
    fi
  fi
  source "$DEPENDENCY_DIR/bin/activate"
}

setup_node_env() {
  setup_env "node_modules/" "npm install"
}

setup_elixir_env() {
  setup_env "deps/" "mix setup"
}


# â–ˆâ–€â–„â–€â–ˆ â–„â–€â–ˆ â–ˆ â–ˆâ–„â–‘â–ˆ
# â–ˆâ–‘â–€â–‘â–ˆ â–ˆâ–€â–ˆ â–ˆ â–ˆâ–‘â–€â–ˆ

main() {
  if ! command -v tmux >/dev/null; then
    echo "Tmux is required for full functionality."
    echo "Install with: sudo apt install tmux (or equivalent for your OS)"
    exit 0
  fi
  init_services

  # SESSION_NAME Fallback
  if [[ -z "$SESSION_NAME" ]]; then
    SESSION_NAME="$(basename "$PWD")"
  fi

  # Attach session if exists
  if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Session '$SESSION_NAME' already exists. Attaching..."
    tmux attach -t "$SESSION_NAME"
    exit 0
  fi

  # Primary Setup
  case "$PRIMARY_SETUP" in
  "none")
    setup_default_layout
    ;;
  "python")
    setup_python_env
    setup_python_layout
    ;;
  "django")
    setup_python_env
    setup_django_layout
    ;;
  "fastapi")
    setup_python_env
    setup_fastapi_layout
    ;;
  "nodejs")
    setup_node_env
    setup_node_layout
    ;;
  "nextjs")
    setup_node_env
    setup_nextjs_layout
    ;;
  "elixir")
    setup_elixir_env
    setup_elixir_layout
    ;;
  "rust")
    setup_rust_layout
    ;;
  "custom")
    setup_custom_layout
    ;;
  *)
    echo "Unknown primary language: $PRIMARY_SETUP"
    echo "Using default layout..."
    setup_default_layout
    ;;
  esac

  tmux attach -t "$SESSION_NAME"
}

main
